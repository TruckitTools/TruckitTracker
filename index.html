<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TruckitTracking</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body { margin:0; font-family:Arial,sans-serif; background:#000; color:#e5e7eb; }
header { background:#020617; color:#22c55e; padding:15px; text-align:center; border-bottom:1px solid #14532d; }
.container { padding:15px; }
.card { background:#020617; border-radius:8px; padding:15px; margin-bottom:15px; border:1px solid #14532d; }
button { background:#16a34a; color:#000; border:none; padding:10px 14px; border-radius:6px; cursor:pointer; font-size:16px; margin:5px 0; position:relative; }
button.cancel { background:#dc2626; color:#fff; }
button.remove-stop { background:#991b1b; color:#fff; font-size:14px; padding:8px 12px; }
button:disabled { opacity:0.6; cursor:not-allowed; }
input, select, textarea { padding:10px; width:100%; margin-bottom:12px; background:#000; color:#22c55e; border:1px solid #14532d; border-radius:6px; font-size:16px; }
.hidden { display:none; }
#map { height:400px; border-radius:8px; margin:15px 0; }
.ref { font-size:20px; font-weight:bold; color:#22c55e; }
.message { background:#022c22; padding:8px; border-radius:5px; margin-top:6px; font-size:14px; }
.driver-info { background:#022c22; padding:10px; border-radius:5px; margin-bottom:12px; font-size:14px; line-height:1.6; }
.photo-preview { width:100%; max-height:300px; object-fit:contain; margin:10px 0; border-radius:8px; background:#111; display:block; }
#truckPreview.hidden { display:none; }
.camera-btn { background:#1e40af; margin-top:10px; }
#photoStatus { color:#22c55e; margin-top:8px; min-height:24px; }
.role-buttons { display:flex; flex-direction:column; align-items:center; gap:20px; margin:30px 0; }
.role-buttons button { width:280px; padding:20px; font-size:20px; }
details { margin-top:15px; background:#022c22; padding:10px; border-radius:6px; }
summary { cursor:pointer; font-weight:bold; color:#22c55e; }
.history-item { font-size:14px; padding:6px 0; border-bottom:1px solid #14532d; }
.history-item:last-child { border-bottom:none; }
.spinner { display:inline-block; width:16px; height:16px; border:2px solid #fff; border-top-color:transparent; border-radius:50%; animation:spin 1s linear infinite; margin-left:8px; vertical-align:middle; }
@keyframes spin { to { transform:rotate(360deg); } }
.geofence-alert { background:#166534; padding:14px; border-radius:8px; font-weight:bold; font-size:17px; margin:10px 0; text-align:center; border:2px solid #22c55e; }
#geofenceStatus { min-height:24px; font-size:14px; color:#94a3b8; margin-top:10px; }
.stop-group { background:#022c22; padding:15px; border-radius:8px; margin-bottom:15px; position:relative; }
.stop-header { font-weight:bold; color:#22c55e; margin-bottom:10px; font-size:18px; }
.stop-fields { display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:end; }
.pickup-group { background:#1e3a8a; padding:15px; border-radius:8px; margin-bottom:20px; border:2px solid #3b82f6; }
.pickup-header { font-weight:bold; color:#60a5fa; font-size:18px; margin-bottom:10px; }
@media (max-width: 600px) { .stop-fields { grid-template-columns: 1fr; } }
</style>
</head>
<body>

<header>
<h2>TruckitTracking</h2>
<p>Secure Carrier & Broker Tracking (Local Browser Storage)</p>
</header>

<div class="container">

<div class="card" id="roleSelect">
<div class="role-buttons">
<button onclick="selectRole('carrier')">I am a Carrier</button>
<button onclick="selectRole('broker')">I am a Broker</button>
</div>
</div>

<div class="card hidden" id="carrierPanel">
<h3>Carrier Session</h3>
<p>Tracking Reference:</p>
<div style="display:flex; align-items:center; gap:10px;">
<span class="ref" id="refNumber">—</span>
<button id="copyRefBtn" onclick="copyRef()"> Copy</button>
</div>
<span class="copy-status" id="copyStatus"></span>

<h4>Driver Info</h4>
<input type="text" id="driverName" placeholder="Driver Name">
<input type="tel" id="driverPhone" placeholder="Phone Number">
<input type="text" id="mcNumber" placeholder="MC Number">

<h4>Truck & MC Photo (Required)</h4>
<p style="font-size:14px; color:#94a3b8;">Take a clear photo of the truck & trailer</p>
<input type="file" id="truckPhoto" accept="image/*" capture="environment" style="display:none;">
<button id="cameraBtn" onclick="document.getElementById('truckPhoto').click()" class="camera-btn"> Open Camera / Choose Photo</button>
<img id="truckPreview" class="photo-preview hidden" alt="Truck preview">
<div id="photoStatus"></div>

<button id="startTracking" style="margin-top:20px;">Start Tracking</button>
<button id="cancelTracking" class="cancel hidden">Cancel Tracking Session</button>

<h4>Messages from Broker</h4>
<div id="carrierMessages"></div>

<h4>Message Broker</h4>
<textarea id="carrierMessage" rows="3" placeholder="Type message to broker..."></textarea>
<button onclick="sendMessage()">Send Message</button>
</div>

<div class="card hidden" id="brokerPanel">
<h3>Broker Controls</h3>

<div style="display:flex; gap:10px; align-items:end;">
<input id="brokerRefInput" placeholder="Enter Reference Number (e.g. TR-ABC123)" style="flex:1;">
<button id="brokerStartTracking" onclick="startBrokerTracking()">Trackit!</button>
</div>
<button onclick="cancelBrokerTracking()" class="cancel hidden" id="cancelBrokerBtn">Cancel Tracking</button>

<h4>Load Locations & Alerts</h4>
<p style="font-size:14px; color:#94a3b8;">
Set the pickup location and all delivery stops.<br>
<strong>Alerts:</strong> "Departed Pickup" when carrier leaves pickup • "Arrived" at each delivery<br>
<strong>Tip:</strong> Include city, state, USA for best address search.
</p>

<!-- Pickup Location -->
<div class="pickup-group">
  <div class="pickup-header">Pickup Location</div>
  <div class="stop-fields">
    <input type="text" id="pickupAddress" placeholder="Pickup Address">
    <select id="pickupRadius">
      <option value="5">5 miles</option>
      <option value="10" selected>10 miles</option>
      <option value="20">20 miles</option>
      <option value="30">30 miles</option>
      <option value="50">50 miles</option>
    </select>
  </div>
</div>

<!-- Delivery Stops -->
<h4 style="margin-top:20px;">Delivery Stops</h4>

<div id="stopsContainer">
  <div class="stop-group">
    <div class="stop-header">Delivery Stop 1</div>
    <div class="stop-fields">
      <input type="text" class="stopAddress" placeholder="Delivery Address">
      <select class="stopRadius">
        <option value="1">1 mile</option>
        <option value="2">2 miles</option>
        <option value="5" selected>5 miles</option>
        <option value="10">10 miles</option>
        <option value="20">20 miles</option>
        <option value="30">30 miles</option>
        <option value="50">50 miles</option>
      </select>
    </div>
  </div>
</div>

<div style="margin:20px 0;">
<button onclick="addStop()" style="background:#16a34a; padding:12px 20px; font-size:18px;">+ Add Delivery Stop</button>
<button onclick="updateAllLocations()" style="margin-left:15px; background:#1e40af; padding:12px 20px; font-size:18px;">Update All Locations</button>
</div>
<div id="geofenceStatus">No locations configured yet.</div>

<!-- Live Map -->
<div class="card" id="mapCard" class="hidden">
<h3>Live Map</h3>
<div id="map"></div>
</div>

<details>
<summary>Tracking History</summary>
<div id="trackingHistory">No location updates yet.</div>
</details>

<h4>Carrier Lookup (MC or DOT)</h4>
<div style="display:flex; gap:10px;">
<input type="text" id="lookupInput" placeholder="Enter MC or DOT number">
<button id="lookupBtn" onclick="lookupCarrier()">Search</button>
</div>
<div id="lookupResult">Enter an MC or DOT number to view official FMCSA profiles.</div>

<h4>Driver Info</h4>
<div id="brokerDriverInfo" class="driver-info">No driver info yet.</div>

<h4>Truck Photo</h4>
<div id="brokerPhotos">No photo yet.</div>

<h4>Notifications</h4>
<div id="brokerAlerts"></div>

<h4>Messages</h4>
<div id="brokerMessages"></div>

<textarea id="brokerMessage" rows="3" placeholder="Type message..."></textarea>
<button onclick="sendBrokerMessage()">Send</button>
</div>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
// LocalStorage key prefix
const STORAGE_KEY = 'truckit_';

// Global variables
let sessionRef = null; // Carrier's current reference
let currentRef = null; // Broker's current tracked reference
let map = null, marker = null, watchId = null;
let pickupLocation = null; // {lat, lng, radius, circle, marker, inside: true/false, triggeredDeparture: false}
let deliveryStops = []; // array of {lat, lng, radius, circle, marker, triggered}
let lastLat = null, lastLng = null;

// Utility functions
function saveSession(ref, data) {
  localStorage.setItem(STORAGE_KEY + ref, JSON.stringify(data));
}

function loadSession(ref) {
  const raw = localStorage.getItem(STORAGE_KEY + ref);
  return raw ? JSON.parse(raw) : null;
}

function deleteSession(ref) {
  localStorage.removeItem(STORAGE_KEY + ref);
}

// Role selection
function selectRole(role) {
  document.getElementById("roleSelect").classList.add("hidden");
  if (role === "carrier") {
    document.getElementById("carrierPanel").classList.remove("hidden");
    sessionRef = "TR-" + Math.random().toString(36).substring(2, 8).toUpperCase();
    document.getElementById("refNumber").textContent = sessionRef;
    saveSession(sessionRef, { createdAt: Date.now(), messages: [], history: [] });
  } else {
    document.getElementById("brokerPanel").classList.remove("hidden");
  }
}

function copyRef() {
  navigator.clipboard.writeText(sessionRef).then(() => {
    document.getElementById("copyStatus").textContent = "Copied!";
    setTimeout(() => document.getElementById("copyStatus").textContent = "", 2000);
  });
}

// Carrier: Image compression (returns data URL)
async function compressImage(file, maxWidth = 1200, quality = 0.8) {
  return new Promise(resolve => {
    const img = new Image();
    const reader = new FileReader();
    reader.onload = e => img.src = e.target.result;
    img.onload = () => {
      const canvas = document.createElement('canvas');
      let w = img.width, h = img.height;
      if (w > maxWidth) { h = (maxWidth / w) * h; w = maxWidth; }
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);
      resolve(canvas.toDataURL("image/jpeg", quality));
    };
    reader.readAsDataURL(file);
  });
}

document.getElementById("truckPhoto").addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;
  const preview = document.getElementById("truckPreview");
  const status = document.getElementById("photoStatus");
  preview.src = URL.createObjectURL(file);
  preview.classList.remove("hidden");
  status.textContent = "Compressing...";
  try {
    const compressedDataUrl = await compressImage(file);
    status.textContent = "Ready!";
    e.target.compressedDataUrl = compressedDataUrl;
  } catch {
    status.textContent = "Using original";
    e.target.compressedDataUrl = URL.createObjectURL(file);
  }
});

// Map initialization (broker only)
function initMap() {
  if (map) return;
  map = L.map('map').setView([39.8, -98.5], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  document.getElementById("mapCard").classList.remove("hidden");
  setTimeout(() => map.invalidateSize(), 300);
}

// GPS tracking (carrier)
function startGPS() {
  if (!navigator.geolocation) return alert("Geolocation not supported.");
  watchId = navigator.geolocation.watchPosition(pos => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    const time = new Date().toLocaleString();
    lastLat = lat;
    lastLng = lng;

    const session = loadSession(sessionRef) || {};
    session.lat = lat;
    session.lng = lng;
    if (!session.history) session.history = [];
    session.history.push({ lat, lng, time });
    if (session.history.length > 50) session.history.shift();
    saveSession(sessionRef, session);
  }, err => console.error("GPS error:", err), { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 });
}

// Carrier start tracking
document.getElementById("startTracking").onclick = async function () {
  const btn = this;
  if (btn.textContent.includes("Pause")) {
    if (watchId) navigator.geolocation.clearWatch(watchId);
    watchId = null;
    btn.textContent = "Resume Tracking";
    return;
  }
  if (btn.textContent.includes("Resume")) {
    startGPS();
    btn.textContent = "Pause Tracking";
    return;
  }

  const fileInput = document.getElementById("truckPhoto");
  const photoDataUrl = fileInput.compressedDataUrl;
  if (!photoDataUrl) return alert("Please take a truck photo first.");

  btn.disabled = true;
  btn.innerHTML = 'Starting<span class="spinner"></span>';

  const session = loadSession(sessionRef) || {};
  session.truckPhoto = photoDataUrl;
  session.driverInfo = {
    name: document.getElementById("driverName").value.trim() || "N/A",
    phone: document.getElementById("driverPhone").value.trim() || "N/A",
    mc: document.getElementById("mcNumber").value.trim() || "N/A"
  };
  saveSession(sessionRef, session);

  document.getElementById("photoStatus").textContent = "Shared!";
  startGPS();
  btn.innerHTML = "Pause Tracking";
  btn.disabled = false;
  document.getElementById("cancelTracking").classList.remove("hidden");

  // Poll for broker messages
  setInterval(() => {
    const s = loadSession(sessionRef);
    if (s && s.messages) {
      document.getElementById("carrierMessages").innerHTML = s.messages
        .sort((a, b) => a.time - b.time)
        .map(m => `<div class="message"><strong>${m.from === "broker" ? "Broker" : "You"}:</strong> ${m.text}</div>`)
        .join("");
    }
  }, 3000);
};

document.getElementById("cancelTracking").onclick = () => {
  if (watchId) navigator.geolocation.clearWatch(watchId);
  deleteSession(sessionRef);
  location.reload();
};

function sendMessage() {
  const msg = document.getElementById("carrierMessage").value.trim();
  if (msg && sessionRef) {
    const session = loadSession(sessionRef) || {};
    if (!session.messages) session.messages = [];
    session.messages.push({ text: msg, from: "carrier", time: Date.now() });
    saveSession(sessionRef, session);
    document.getElementById("carrierMessage").value = "";
  }
}

// Broker: Carrier lookup
function lookupCarrier() {
  const input = document.getElementById("lookupInput").value.trim();
  if (!input) return;
  const num = input.replace(/[^0-9]/g, '');
  const saferUrl = `https://safer.fmcsa.dot.gov/query.asp?searchtype=ANY&query_type=queryCarrierSnapshot&query_param=USDOT&query_string=${num}`;
  const liUrl = `https://li-public.fmcsa.dot.gov/LIVIEW/pkg_html.prc_li`;
  document.getElementById("lookupResult").innerHTML = `
    <strong>FMCSA Profiles for ${num}:</strong><br><br>
    <a href="${saferUrl}" target="_blank" style="color:#22c55e;">SAFER Snapshot </a><br><br>
    <a href="${liUrl}" target="_blank" style="color:#22c55e;">Licensing & Insurance </a>
  `;
}

// Multi-stop UI helpers
function addStop() {
  const container = document.getElementById("stopsContainer");
  const count = container.querySelectorAll(".stop-group").length + 1;
  const group = document.createElement("div");
  group.className = "stop-group";
  group.innerHTML = `
    <div class="stop-header">Delivery Stop ${count}</div>
    <button class="remove-stop" onclick="this.closest('.stop-group').remove(); updateStopNumbers();"> Remove</button>
    <div class="stop-fields">
      <input type="text" class="stopAddress" placeholder="Delivery Address">
      <select class="stopRadius">
        <option value="1">1 mile</option>
        <option value="2">2 miles</option>
        <option value="5" selected>5 miles</option>
        <option value="10">10 miles</option>
        <option value="20">20 miles</option>
        <option value="30">30 miles</option>
        <option value="50">50 miles</option>
      </select>
    </div>
  `;
  container.appendChild(group);
}

function updateStopNumbers() {
  document.querySelectorAll(".stop-header").forEach((h, i) => h.textContent = `Delivery Stop ${i + 1}`);
}

// Geocode (Nominatim)
async function geocodeAddress(rawAddress) {
  let address = rawAddress.trim();
  if (!address) return null;
  if (!address.match(/,\s*(USA|United States|US)$/i)) address += ", USA";
  await new Promise(r => setTimeout(r, 1200));
  try {
    const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1&addressdetails=1`, {
      headers: { 'User-Agent': 'TruckitTracking/1.0' }
    });
    const data = await resp.json();
    if (data && data[0]) {
      return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon), name: data[0].display_name || rawAddress };
    }
  } catch (e) { console.error(e); }
  return null;
}

// Draw geofence visuals
function drawPickupGeofence(data) {
  const circle = L.circle([data.lat, data.lng], { radius: data.radius * 1609.34, color: '#3b82f6', fillOpacity: 0.2 }).addTo(map);
  const marker = L.marker([data.lat, data.lng]).addTo(map).bindPopup(`<strong>Pickup</strong><br>${data.name}<br>Radius: ${data.radius} miles`);
  return { circle, marker };
}

function drawDeliveryGeofence(data) {
  const circle = L.circle([data.lat, data.lng], { radius: data.radius * 1609.34, color: '#22c55e', fillOpacity: 0.15 }).addTo(map);
  const marker = L.marker([data.lat, data.lng]).addTo(map).bindPopup(`<strong>Delivery</strong><br>${data.name}<br>Radius: ${data.radius} miles`);
  return { circle, marker };
}

// Update all locations (pickup + deliveries)
async function updateAllLocations() {
  if (!currentRef) return alert("Start tracking a reference first.");
  const status = document.getElementById("geofenceStatus");
  status.textContent = "Updating locations...";

  // Clear old
  if (pickupLocation) {
    map.removeLayer(pickupLocation.circle);
    map.removeLayer(pickupLocation.marker);
    pickupLocation = null;
  }
  deliveryStops.forEach(s => {
    map.removeLayer(s.circle);
    map.removeLayer(s.marker);
  });
  deliveryStops = [];

  let validCount = 0;

  // Pickup
  const pickupAddr = document.getElementById("pickupAddress").value.trim();
  const pickupRad = parseFloat(document.getElementById("pickupRadius").value);
  if (pickupAddr) {
    const result = await geocodeAddress(pickupAddr);
    if (result) {
      const visuals = drawPickupGeofence({ ...result, radius: pickupRad });
      pickupLocation = { ...result, radius: pickupRad, inside: true, triggeredDeparture: false, ...visuals };
      validCount++;
    }
  }

  // Deliveries
  const entries = document.querySelectorAll(".stop-group");
  const stops = [];
  for (let entry of entries) {
    const addr = entry.querySelector(".stopAddress").value.trim();
    const rad = parseFloat(entry.querySelector(".stopRadius").value);
    if (!addr) continue;
    const result = await geocodeAddress(addr);
    if (result) {
      const visuals = drawDeliveryGeofence({ ...result, radius: rad });
      deliveryStops.push({ ...result, radius: rad, triggered: false, ...visuals });
      stops.push({ address: addr, name: result.name, radius: rad, lat: result.lat, lng: result.lng });
      validCount++;
    }
  }

  // Save
  const saveData = { pickup: pickupAddr ? { address: pickupAddr, radius: pickupRad } : null, deliveries: stops };
  const session = loadSession(currentRef) || {};
  session.locations = saveData;
  saveSession(currentRef, session);

  status.textContent = validCount > 0 ? `Active: \( {pickupAddr ? 'Pickup + ' : ''} \){stops.length} delivery stop(s)` : "No valid locations.";
}

// Load saved locations
function loadSavedLocations() {
  const session = loadSession(currentRef);
  if (!session || !session.locations) return;

  const data = session.locations;
  if (data.pickup) {
    document.getElementById("pickupAddress").value = data.pickup.address || "";
    document.getElementById("pickupRadius").value = data.pickup.radius || 10;
  }

  const container = document.getElementById("stopsContainer");
  container.innerHTML = `<div class="stop-group">
    <div class="stop-header">Delivery Stop 1</div>
    <div class="stop-fields">
      <input type="text" class="stopAddress" placeholder="Delivery Address">
      <select class="stopRadius">
        <option value="1">1 mile</option>
        <option value="2">2 miles</option>
        <option value="5" selected>5 miles</option>
        <option value="10">10 miles</option>
        <option value="20">20 miles</option>
        <option value="30">30 miles</option>
        <option value="50">50 miles</option>
      </select>
    </div>
  </div>`;

  data.deliveries.forEach((stop, i) => {
    if (i === 0) {
      container.querySelector(".stopAddress").value = stop.address || "";
      container.querySelector(".stopRadius").value = stop.radius || 5;
    } else {
      addStop();
      const groups = container.querySelectorAll(".stop-group");
      const last = groups[groups.length - 1];
      last.querySelector(".stopAddress").value = stop.address || "";
      last.querySelector(".stopRadius").value = stop.radius || 5;
    }
  });
}

// Broker start tracking
function startBrokerTracking() {
  const ref = document.getElementById("brokerRefInput").value.trim().toUpperCase();
  if (!ref) return alert("Enter reference number");
  currentRef = ref;

  initMap();
  document.getElementById("cancelBrokerBtn").classList.remove("hidden");

  loadSavedLocations();
  updateAllLocations(); // Initial draw

  // Poll for updates from carrier
  setInterval(() => {
    const session = loadSession(currentRef);
    if (!session) {
      document.getElementById("brokerDriverInfo").innerHTML = "Invalid/expired reference.";
      document.getElementById("brokerPhotos").innerHTML = "No session found.";
      document.getElementById("trackingHistory").innerHTML = "No session found.";
      return;
    }

    // Driver info & photo
    if (session.driverInfo) {
      document.getElementById("brokerDriverInfo").innerHTML = `
        <strong>Name:</strong> ${session.driverInfo.name}<br>
        <strong>Phone:</strong> ${session.driverInfo.phone}<br>
        <strong>MC#:</strong> ${session.driverInfo.mc}`;
    }
    if (session.truckPhoto) {
      document.getElementById("brokerPhotos").innerHTML = `<img src="${session.truckPhoto}" class="photo-preview">`;
    }

    // Messages
    if (session.messages) {
      document.getElementById("brokerMessages").innerHTML = session.messages
        .sort((a, b) => a.time - b.time)
        .map(m => `<div class="message"><strong>${m.from === "carrier" ? "Carrier" : "You"}:</strong> ${m.text}</div>`)
        .join("");
    }

    // Location & alerts
    if (session.lat && session.lng) {
      const latlng = [session.lat, session.lng];
      if (marker) marker.setLatLng(latlng);
      else marker = L.marker(latlng).addTo(map).bindPopup("Carrier").openPopup();
      map.setView(latlng, 13);

      // Pickup departure
      if (pickupLocation && pickupLocation.inside && !pickupLocation.triggeredDeparture) {
        const dist = getDistance(session.lat, session.lng, pickupLocation.lat, pickupLocation.lng);
        if (dist > pickupLocation.radius) {
          pickupLocation.inside = false;
          pickupLocation.triggeredDeparture = true;
          const alert = document.createElement("div");
          alert.className = "geofence-alert";
          alert.innerHTML = ` CARRIER DEPARTED PICKUP<br>${pickupLocation.name}<br>Time: ${new Date().toLocaleString()}`;
          document.getElementById("brokerAlerts").prepend(alert);
        }
      }

      // Delivery arrivals
      deliveryStops.forEach(stop => {
        if (!stop.triggered) {
          const dist = getDistance(session.lat, session.lng, stop.lat, stop.lng);
          if (dist <= stop.radius) {
            stop.triggered = true;
            const alert = document.createElement("div");
            alert.className = "geofence-alert";
            alert.innerHTML = ` CARRIER ARRIVED at Delivery<br>${stop.name}<br>Time: ${new Date().toLocaleString()}`;
            document.getElementById("brokerAlerts").prepend(alert);
          }
        }
      });
    }

    // History
    if (session.history) {
      document.getElementById("trackingHistory").innerHTML = session.history.reverse()
        .map(e => `<div class="history-item">${e.time}<br>Lat: ${e.lat.toFixed(6)}, Lng: ${e.lng.toFixed(6)}</div>`)
        .join("");
    }
  }, 5000); // Poll every 5 seconds
}

function cancelBrokerTracking() {
  currentRef = null;
  location.reload();
}

function sendBrokerMessage() {
  const msg = document.getElementById("brokerMessage").value.trim();
  if (msg && currentRef) {
    const session = loadSession(currentRef) || {};
    if (!session.messages) session.messages = [];
    session.messages.push({ text: msg, from: "broker", time: Date.now() });
    saveSession(currentRef, session);
    document.getElementById("brokerMessage").value = "";
  }
}

function getDistance(lat1, lon1, lat2, lon2) {
  const R = 3958.8; // miles
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

document.getElementById("pingMode").onchange = () => {
  const isTime = document.getElementById("pingMode").value === "time";
  document.getElementById("pingInterval").classList.toggle("hidden", !isTime);
  document.getElementById("distanceInterval").classList.toggle("hidden", isTime);
};
</script>
</body>
</html>