<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TruckitTracking</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body { margin:0; font-family:Arial,sans-serif; background:#000; color:#e5e7eb; }
header { background:#020617; color:#22c55e; padding:15px; text-align:center; border-bottom:1px solid #14532d; }
.container { padding:15px; }
.card { background:#020617; border-radius:8px; padding:15px; margin-bottom:15px; border:1px solid #14532d; }
button { background:#16a34a; color:#000; border:none; padding:10px 14px; border-radius:6px; cursor:pointer; font-size:16px; margin:5px 0; position:relative; }
button.cancel { background:#dc2626; color:#fff; }
button:disabled { opacity:0.6; cursor:not-allowed; }
input, textarea { padding:10px; width:100%; margin-bottom:12px; background:#000; color:#22c55e; border:1px solid #14532d; border-radius:6px; font-size:16px; }
.hidden { display:none; }
#map { height:400px; border-radius:8px; margin-top:10px; }
.ref { font-size:20px; font-weight:bold; color:#22c55e; }
.message { background:#022c22; padding:8px; border-radius:5px; margin-top:6px; font-size:14px; }
.driver-info { background:#022c22; padding:10px; border-radius:5px; margin-bottom:12px; font-size:14px; line-height:1.6; }
.photo-preview { width:100%; max-height:300px; object-fit:contain; margin:10px 0; border-radius:8px; background:#111; display:block; }
#truckPreview.hidden { display:none; }
.camera-btn { background:#1e40af; margin-top:10px; }
#photoStatus { color:#22c55e; margin-top:8px; min-height:24px; }
.role-buttons { display:flex; flex-direction:column; align-items:center; gap:20px; margin:30px 0; }
.role-buttons button { width:280px; padding:20px; font-size:20px; }
details { margin-top:15px; background:#022c22; padding:10px; border-radius:6px; }
summary { cursor:pointer; font-weight:bold; color:#22c55e; }
.history-item { font-size:14px; padding:6px 0; border-bottom:1px solid #14532d; }
.history-item:last-child { border-bottom:none; }
.spinner { display:inline-block; width:16px; height:16px; border:2px solid #fff; border-top-color:transparent; border-radius:50%; animation:spin 1s linear infinite; margin-left:8px; vertical-align:middle; }
@keyframes spin { to { transform:rotate(360deg); } }
.load-details-view { background:#022c22; padding:12px; border-radius:6px; margin-top:10px; line-height:1.8; font-size:14px; }
.load-details-view strong { color:#22c55e; }
.field-label { font-size:14px; color:#94a3b8; margin-bottom:4px; display:block; }
</style>
</head>
<body>

<header>
<h2>TruckitTracking</h2>
<p>Carrier Tracking and Broker Tools</p>
</header>

<div class="container">

<!-- Role Selection -->
<div class="card" id="roleSelect">
<div class="role-buttons">
<button onclick="selectRole('carrier')">Carrier</button>
<button onclick="selectRole('broker')">Broker</button>
</div>
</div>

<!-- Carrier Panel -->
<div class="card hidden" id="carrierPanel">
<h3>Carrier Session</h3>
<p>Tracking Reference:</p>
<div style="display:flex; align-items:center; gap:10px;">
<span class="ref" id="refNumber">—</span>
<button id="copyRefBtn" onclick="copyRef()">Copy</button>
</div>
<span class="copy-status" id="copyStatus"></span>

<!-- Carrier: Load Details (Read-only, starts collapsed) -->
<details>
<summary>Load Details</summary>
<div id="carrierLoadDetails" class="load-details-view">
No load details shared yet.
</div>
</details>

<!-- Driver Info heading will change dynamically -->
<h4 id="driverHeading">Add driver details</h4>
<input type="text" id="driverName" placeholder="Driver Name">
<input type="tel" id="driverPhone" placeholder="Phone Number">
<input type="text" id="mcNumber" placeholder="MC Number">

<details>
<summary>Truck & MC Photo (Required)</summary>
<p style="font-size:14px; color:#94a3b8;">Take a clear photo of the truck & trailer</p>
<input type="file" id="truckPhoto" accept="image/*" capture="environment" style="display:none;">
<button id="cameraBtn" onclick="document.getElementById('truckPhoto').click()" class="camera-btn">Open Camera / Choose Photo</button>
<img id="truckPreview" class="photo-preview hidden" alt="Truck preview">
<div id="photoStatus"></div>
</details>

<button id="startTracking" style="margin-top:20px;">Start Tracking</button>
<button id="cancelTracking" class="cancel hidden">Cancel Tracking Session</button>

<h4>Messages from Broker</h4>
<div id="carrierMessages"></div>

<h4>Message Broker</h4>
<textarea id="carrierMessage" rows="3" placeholder="Type message to broker..."></textarea>
<button onclick="sendMessage()">Send Message</button>
</div>
  
<!-- Broker Panel -->
<div class="card hidden" id="brokerPanel">
<h3>Broker Controls</h3>

<div style="display:flex; gap:10px; align-items:end;">
<input id="brokerRefInput" placeholder="Enter Reference Number (e.g. TR-ABC123)" style="flex:1;">
<button id="brokerStartTracking" onclick="startBrokerTracking()">Trackit!</button>
</div>
<button onclick="cancelBrokerTracking()" class="cancel hidden" id="cancelBrokerBtn">Cancel Tracking</button>

<h4>Carrier Lookup (MC or DOT)</h4>
<div style="display:flex; gap:10px;">
<input type="text" id="lookupInput" placeholder="Enter MC or DOT number">
<button id="lookupBtn" onclick="lookupCarrier()">Search</button>
</div>
<div id="lookupResult">Enter an MC or DOT number to view official FMCSA profiles.</div>

<details>
<summary>Driver Info</summary>
<div id="brokerDriverInfo" class="driver-info">No driver info yet.</div>
</details>

<!-- Broker: Load Details (with visible date labels) -->
<details>
<summary>Load Details</summary>
<p style="font-size:14px; color:#94a3b8; margin-bottom:15px;">
Enter load information. Pickup/Delivery locations, dates, and notes are visible to the carrier.
</p>

<input type="text" id="loadId" placeholder="Load ID / BOL #" oninput="saveLoadDetails()">
<input type="text" id="commodity" placeholder="Commodity" oninput="saveLoadDetails()">
<input type="text" id="weight" placeholder="Weight (e.g. 42,000 lbs)" oninput="saveLoadDetails()">
<input type="text" id="pickupLocation" placeholder="Pickup Location" oninput="saveLoadDetails()">
<input type="text" id="deliveryLocation" placeholder="Delivery Location" oninput="saveLoadDetails()">

<span class="field-label">Pickup Date/Time (optional)</span>
<input type="datetime-local" id="pickupDate" placeholder="Pickup Date/Time (optional)" oninput="saveLoadDetails()">

<span class="field-label">Delivery Date/Time (optional)</span>
<input type="datetime-local" id="deliveryDate" placeholder="Delivery Date/Time (optional)" oninput="saveLoadDetails()">

<input type="text" id="rate" placeholder="Rate (optional)" oninput="saveLoadDetails()">
<textarea id="loadNotes" rows="3" placeholder="Notes (visible to carrier)" oninput="saveLoadDetails()"></textarea>
</details>

<details>
<summary>Live Map</summary>
<div id="map"></div>
</details>

<details>
<summary>Tracking History</summary>
<div id="trackingHistory">No location updates yet.</div>
</details>

<details>
<summary>Truck Photo</summary>
<div id="brokerPhotos">No photo yet.</div>
</details>

<h4>Carrier Messages</h4>
<div id="brokerMessages"></div>

<h4>Send Message to Carrier</h4>
<textarea id="brokerMessage" rows="3" placeholder="Type message..."></textarea>
<button onclick="sendBrokerMessage()">Send</button>
</div>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
// LocalStorage key prefix
const STORAGE_KEY = 'truckit_';

// Global variables
let sessionRef = null;
let currentRef = null;
let map = null, marker = null, watchId = null;
let lastLat = null, lastLng = null;

// Utility functions
function saveSession(ref, data) {
  localStorage.setItem(STORAGE_KEY + ref, JSON.stringify(data));
}

function loadSession(ref) {
  const raw = localStorage.getItem(STORAGE_KEY + ref);
  return raw ? JSON.parse(raw) : null;
}

function deleteSession(ref) {
  localStorage.removeItem(STORAGE_KEY + ref);
}

// Role selection
function selectRole(role) {
  document.getElementById("roleSelect").classList.add("hidden");
  if (role === "carrier") {
    document.getElementById("carrierPanel").classList.remove("hidden");
    sessionRef = "TR-" + Math.random().toString(36).substring(2, 8).toUpperCase();
    document.getElementById("refNumber").textContent = sessionRef;
    saveSession(sessionRef, { createdAt: Date.now(), messages: [], history: [] });
    updateCarrierLoadDetails();
  } else {
    document.getElementById("brokerPanel").classList.remove("hidden");
  }
}

function copyRef() {
  navigator.clipboard.writeText(sessionRef).then(() => {
    document.getElementById("copyStatus").textContent = "Copied!";
    setTimeout(() => document.getElementById("copyStatus").textContent = "", 2000);
  });
}
  
// Carrier: Image compression
async function compressImage(file, maxWidth = 1200, quality = 0.8) {
  return new Promise(resolve => {
    const img = new Image();
    const reader = new FileReader();
    reader.onload = e => img.src = e.target.result;
    img.onload = () => {
      const canvas = document.createElement('canvas');
      let w = img.width, h = img.height;
      if (w > maxWidth) { h = (maxWidth / w) * h; w = maxWidth; }
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);
      resolve(canvas.toDataURL("image/jpeg", quality));
    };
    reader.readAsDataURL(file);
  });
}

document.getElementById("truckPhoto").addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;
  const preview = document.getElementById("truckPreview");
  const status = document.getElementById("photoStatus");
  preview.src = URL.createObjectURL(file);
  preview.classList.remove("hidden");
  status.textContent = "Compressing...";
  try {
    const compressedDataUrl = await compressImage(file);
    status.textContent = "Ready!";
    e.target.compressedDataUrl = compressedDataUrl;
  } catch {
    status.textContent = "Using original";
    e.target.compressedDataUrl = URL.createObjectURL(file);
  }
});

// Map initialization
function initMap() {
  if (map) return;
  map = L.map('map').setView([39.8, -98.5], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  setTimeout(() => map.invalidateSize(), 300);
}

// GPS tracking
function startGPS() {
  if (!navigator.geolocation) return alert("Geolocation not supported.");
  watchId = navigator.geolocation.watchPosition(pos => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    const time = new Date().toLocaleString();
    lastLat = lat;
    lastLng = lng;

    const session = loadSession(sessionRef) || {};
    session.lat = lat;
    session.lng = lng;
    if (!session.history) session.history = [];
    session.history.push({ lat, lng, time });
    if (session.history.length > 50) session.history.shift();
    saveSession(sessionRef, session);
  }, err => console.error("GPS error:", err), { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 });
}

// Update driver heading based on whether info exists and tracking started
function updateDriverHeading() {
  const heading = document.getElementById("driverHeading");
  if (!heading) return;
  const session = loadSession(sessionRef);
  const hasDriverInfo = session && session.driverInfo && 
    (session.driverInfo.name !== "N/A" || session.driverInfo.phone !== "N/A" || session.driverInfo.mc !== "N/A");
  heading.textContent = hasDriverInfo ? "Driver details" : "Add driver details";
}

// Carrier start tracking
document.getElementById("startTracking").onclick = async function () {
  const btn = this;
  if (btn.textContent.includes("Pause")) {
    if (watchId) navigator.geolocation.clearWatch(watchId);
    watchId = null;
    btn.textContent = "Resume Tracking";
    return;
  }
  if (btn.textContent.includes("Resume")) {
    startGPS();
    btn.textContent = "Pause Tracking";
    return;
  }

  const fileInput = document.getElementById("truckPhoto");
  const photoDataUrl = fileInput.compressedDataUrl;
  if (!photoDataUrl) return alert("Please take a truck photo first.");

  btn.disabled = true;
  btn.innerHTML = 'Starting<span class="spinner"></span>';

  const session = loadSession(sessionRef) || {};
  session.truckPhoto = photoDataUrl;
  session.driverInfo = {
    name: document.getElementById("driverName").value.trim() || "N/A",
    phone: document.getElementById("driverPhone").value.trim() || "N/A",
    mc: document.getElementById("mcNumber").value.trim() || "N/A"
  };
  saveSession(sessionRef, session);

  document.getElementById("photoStatus").textContent = "Shared!";
  startGPS();
  btn.innerHTML = "Pause Tracking";
  btn.disabled = false;
  document.getElementById("cancelTracking").classList.remove("hidden");
  updateDriverHeading();

  setInterval(() => {
    const s = loadSession(sessionRef);
    if (s && s.messages) {
      document.getElementById("carrierMessages").innerHTML = s.messages
        .sort((a, b) => a.time - b.time)
        .map(m => `<div class="message"><strong>${m.from === "broker" ? "Broker" : "You"}:</strong> ${m.text}</div>`)
        .join("");
    }
    updateCarrierLoadDetails();
    updateDriverHeading();
  }, 3000);
};

document.getElementById("cancelTracking").onclick = () => {
  if (watchId) navigator.geolocation.clearWatch(watchId);
  deleteSession(sessionRef);
  location.reload();
};

function sendMessage() {
  const msg = document.getElementById("carrierMessage").value.trim();
  if (msg && sessionRef) {
    const session = loadSession(sessionRef) || {};
    if (!session.messages) session.messages = [];
    session.messages.push({ text: msg, from: "carrier", time: Date.now() });
    saveSession(sessionRef, session);
    document.getElementById("carrierMessage").value = "";
  }
}

// Broker: Load Details auto-save
function saveLoadDetails() {
  if (!currentRef) return;
  const session = loadSession(currentRef) || {};
  session.loadDetails = {
    loadId: document.getElementById("loadId").value.trim(),
    commodity: document.getElementById("commodity").value.trim(),
    weight: document.getElementById("weight").value.trim(),
    pickupLocation: document.getElementById("pickupLocation").value.trim(),
    deliveryLocation: document.getElementById("deliveryLocation").value.trim(),
    pickupDate: document.getElementById("pickupDate").value,
    deliveryDate: document.getElementById("deliveryDate").value,
    rate: document.getElementById("rate").value.trim(),
    notes: document.getElementById("loadNotes").value.trim()
  };
  saveSession(currentRef, session);
}

// Load saved load details (broker side)
function loadBrokerLoadDetails() {
  const session = loadSession(currentRef);
  if (session && session.loadDetails) {
    const ld = session.loadDetails;
    document.getElementById("loadId").value = ld.loadId || "";
    document.getElementById("commodity").value = ld.commodity || "";
    document.getElementById("weight").value = ld.weight || "";
    document.getElementById("pickupLocation").value = ld.pickupLocation || "";
    document.getElementById("deliveryLocation").value = ld.deliveryLocation || "";
    document.getElementById("pickupDate").value = ld.pickupDate || "";
    document.getElementById("deliveryDate").value = ld.deliveryDate || "";
    document.getElementById("rate").value = ld.rate || "";
    document.getElementById("loadNotes").value = ld.notes || "";
  }
}

// Update carrier read-only view
function updateCarrierLoadDetails() {
  if (!sessionRef) return;
  const session = loadSession(sessionRef);
  const div = document.getElementById("carrierLoadDetails");
  if (session && session.loadDetails) {
    const ld = session.loadDetails;
    let html = "";
    if (ld.pickupLocation) html += `<strong>Pickup:</strong> ${ld.pickupLocation}<br>`;
    if (ld.deliveryLocation) html += `<strong>Delivery:</strong> ${ld.deliveryLocation}<br>`;
    if (ld.pickupDate) html += `<strong>Pickup Date:</strong> ${formatDate(ld.pickupDate)}<br>`;
    if (ld.deliveryDate) html += `<strong>Delivery Date:</strong> ${formatDate(ld.deliveryDate)}<br>`;
    if (ld.notes) html += `<strong>Notes:</strong> ${ld.notes.replace(/\n/g, '<br>')}`;
    div.innerHTML = html || "No load details shared yet.";
  } else {
    div.innerHTML = "No load details shared yet.";
  }
}

function formatDate(datetime) {
  if (!datetime) return "";
  const d = new Date(datetime);
  return d.toLocaleString();
}

// Broker: Carrier lookup
function lookupCarrier() {
  const input = document.getElementById("lookupInput").value.trim();
  if (!input) return;
  const num = input.replace(/[^0-9]/g, '');
  const saferUrl = `https://safer.fmcsa.dot.gov/query.asp?searchtype=ANY&query_type=queryCarrierSnapshot&query_param=USDOT&query_string=${num}`;
  const liUrl = `https://li-public.fmcsa.dot.gov/LIVIEW/pkg_html.prc_li`;
  document.getElementById("lookupResult").innerHTML = `
    <strong>FMCSA Profiles for ${num}:</strong><br><br>
    <a href="${saferUrl}" target="_blank" style="color:#22c55e;">SAFER Snapshot </a><br><br>
    <a href="${liUrl}" target="_blank" style="color:#22c55e;">Licensing & Insurance </a>
  `;
}

// Broker start tracking
function startBrokerTracking() {
  const ref = document.getElementById("brokerRefInput").value.trim().toUpperCase();
  if (!ref) return alert("Enter a reference number.");
  currentRef = ref;
  document.getElementById("cancelBrokerBtn").classList.remove("hidden");
  initMap();
  loadBrokerLoadDetails();
  pollBrokerUpdates();
}

// Broker cancel
function cancelBrokerTracking() {
  currentRef = null;
  document.getElementById("cancelBrokerBtn").classList.add("hidden");
  if (map) map.remove();
  map = null;
  marker = null;
  document.getElementById("brokerMessages").innerHTML = "";
  document.getElementById("trackingHistory").innerHTML = "No location updates yet.";
  document.getElementById("brokerPhotos").innerHTML = "No photo yet.";
  document.getElementById("brokerDriverInfo").innerHTML = "No driver info yet.";
}

// Broker polling
function pollBrokerUpdates() {
  if (!currentRef) return;
  const session = loadSession(currentRef);
  if (session) {
    if (session.lat && session.lng) {
      if (!marker) {
        marker = L.marker([session.lat, session.lng]).addTo(map).bindPopup("Carrier Location");
      } else {
        marker.setLatLng([session.lat, session.lng]);
      }
      map.setView([session.lat, session.lng], 12);
    }

    if (session.driverInfo) {
      const info = session.driverInfo;
      document.getElementById("brokerDriverInfo").innerHTML = `
        <strong>Driver:</strong> ${info.name}<br>
        <strong>Phone:</strong> ${info.phone}<br>
        <strong>MC:</strong> ${info.mc}
      `;
    }

    if (session.truckPhoto) {
      document.getElementById("brokerPhotos").innerHTML = `<img src="${session.truckPhoto}" class="photo-preview" alt="Truck photo">`;
    }

    if (session.messages) {
      document.getElementById("brokerMessages").innerHTML = session.messages
        .sort((a, b) => a.time - b.time)
        .map(m => `<div class="message"><strong>${m.from === "carrier" ? "Carrier" : "You"}:</strong> ${m.text}</div>`)
        .join("");
    }

    if (session.history) {
      document.getElementById("trackingHistory").innerHTML = session.history
        .map(h => `<div class="history-item">${h.time} — Lat: ${h.lat.toFixed(5)}, Lng: ${h.lng.toFixed(5)}</div>`)
        .join("");
    }
  }
  setTimeout(pollBrokerUpdates, 5000);
}

function sendBrokerMessage() {
  const msg = document.getElementById("brokerMessage").value.trim();
  if (msg && currentRef) {
    const session = loadSession(currentRef) || {};
    if (!session.messages) session.messages = [];
    session.messages.push({ text: msg, from: "broker", time: Date.now() });
    saveSession(currentRef, session);
    document.getElementById("brokerMessage").value = "";
  }
}

</script>
</body>
</html>