<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TruckitTracking</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body { margin:0; font-family:Arial,sans-serif; background:#000; color:#e5e7eb; }
header { background:#020617; color:#22c55e; padding:15px; text-align:center; border-bottom:1px solid #14532d; }
.container { padding:15px; }
.card { background:#020617; border-radius:8px; padding:15px; margin-bottom:15px; border:1px solid #14532d; }
button { background:#16a34a; color:#000; border:none; padding:10px 14px; border-radius:6px; cursor:pointer; font-size:16px; margin:5px 0; position:relative; }
button.cancel { background:#dc2626; color:#fff; }
button:disabled { opacity:0.6; cursor:not-allowed; }
input, select, textarea { padding:10px; width:100%; margin-bottom:12px; background:#000; color:#22c55e; border:1px solid #14532d; border-radius:6px; font-size:16px; }
.hidden { display:none; }
#map { height:400px; border-radius:8px; margin-top:10px; }
.ref { font-size:20px; font-weight:bold; color:#22c55e; }
.message { background:#022c22; padding:8px; border-radius:5px; margin-top:6px; font-size:14px; }
.driver-info { background:#022c22; padding:10px; border-radius:5px; margin-bottom:12px; font-size:14px; line-height:1.6; }
.photo-preview { width:100%; max-height:300px; object-fit:contain; margin:10px 0; border-radius:8px; background:#111; display:block; }
#truckPreview.hidden, #pickupPreview.hidden, #deliveryPreview.hidden { display:none; }
.camera-btn { background:#1e40af; margin-top:10px; }
#photoStatus, #pickupStatus, #deliveryStatus { color:#22c55e; margin-top:8px; min-height:24px; }
#lookupResult { background:#022c22; padding:10px; border-radius:6px; margin-top:10px; font-size:14px; line-height:1.6; }
.role-buttons { display:flex; flex-direction:column; align-items:center; gap:20px; margin:30px 0; }
.role-buttons button { width:280px; padding:20px; font-size:20px; }
details { margin-top:15px; background:#022c22; padding:10px; border-radius:6px; }
summary { cursor:pointer; font-weight:bold; color:#22c55e; }
.history-item { font-size:14px; padding:6px 0; border-bottom:1px solid #14532d; }
.history-item:last-child { border-bottom:none; }
#copyRefBtn { padding:6px 10px; font-size:14px; }
/* Loading spinner */
.spinner { display:inline-block; width:16px; height:16px; border:2px solid #fff; border-top-color:transparent; border-radius:50%; animation:spin 1s linear infinite; margin-left:8px; vertical-align:middle; }
@keyframes spin { to { transform:rotate(360deg); } }
/* Geofence circle */
.geofence-circle { opacity:0.3; fill:#22c55e; stroke:#22c55e; stroke-width:2; }
</style>
</head>
<body>

<header>
<h2>TruckitTracking</h2>
<p>Secure Carrier & Broker Tracking</p>
</header>

<div class="container">

<!-- Role Selection -->
<div class="card" id="roleSelect">
<div class="role-buttons">
<button onclick="selectRole('carrier')">Carrier</button>
<button onclick="selectRole('broker')">Broker</button>
</div>
</div>

<!-- Carrier Panel -->
<div class="card hidden" id="carrierPanel">
<h3>Carrier Session</h3>
<p>Tracking Reference:</p>
<div style="display:flex; align-items:center; gap:10px;">
<span class="ref" id="refNumber">—</span>
<button id="copyRefBtn" onclick="copyRef()"> Copy</button>
</div>
<span class="copy-status" id="copyStatus"></span>

<h4>Driver Info</h4>
<input type="text" id="driverName" placeholder="Driver Name">
<input type="tel" id="driverPhone" placeholder="Phone Number">
<input type="text" id="mcNumber" placeholder="MC Number">

<h4>Truck & MC Photo (Required)</h4>
<p style="font-size:14px; color:#94a3b8;">Take a clear photo of the truck & trailer</p>
<input type="file" id="truckPhoto" accept="image/*" capture="environment" style="display:none;">
<button id="cameraBtn" onclick="document.getElementById('truckPhoto').click()" class="camera-btn"> Open Camera / Choose Photo</button>
<img id="truckPreview" class="photo-preview hidden" alt="Truck preview">
<div id="photoStatus"></div>

<h4>Pickup Checkpoint (After Loading)</h4>
<input type="file" id="pickupPhoto" accept="image/*" capture="environment" style="display:none;">
<button onclick="document.getElementById('pickupPhoto').click()" class="camera-btn"> Take Loaded Trailer Photo</button>
<img id="pickupPreview" class="photo-preview hidden" alt="Pickup preview">
<div id="pickupStatus"></div>

<h4>Delivery Checkpoint (On Arrival)</h4>
<input type="file" id="deliveryPhoto" accept="image/*" capture="environment" style="display:none;">
<button onclick="document.getElementById('deliveryPhoto').click()" class="camera-btn"> Take Delivery Arrival Photo</button>
<img id="deliveryPreview" class="photo-preview hidden" alt="Delivery preview">
<div id="deliveryStatus"></div>

<button id="startTracking" style="margin-top:20px;">Start Tracking</button>
<button id="cancelTracking" class="cancel hidden">Cancel Tracking Session</button>

<h4>Messages from Broker</h4>
<div id="carrierMessages"></div>

<h4>Message Broker</h4>
<textarea id="carrierMessage" rows="3" placeholder="Type message to broker..."></textarea>
<button onclick="sendMessage()">Send Message</button>
</div>

<!-- Broker Panel -->
<div class="card hidden" id="brokerPanel">
<h3>Broker Controls</h3>

<div style="display:flex; align-items:center; gap:10px;">
<input id="brokerRefInput" placeholder="Enter Reference Number (e.g. TR-ABC123)">
<button id="brokerStartTracking" onclick="startBrokerTracking()" style="padding:12px 20px; font-size:18px;">Trackit!</button>
</div>
<button onclick="cancelBrokerTracking()" class="cancel hidden" id="cancelBrokerBtn">Cancel Tracking</button>

<h4>Carrier Lookup (MC or DOT)</h4>
<div style="display:flex; gap:10px;">
<input type="text" id="lookupInput" placeholder="Enter MC or DOT number">
<button id="lookupBtn" onclick="lookupCarrier()">Search</button>
</div>
<div id="lookupResult">Enter an MC or DOT number to view official FMCSA profiles.</div>

<h4>Driver Info</h4>
<div id="brokerDriverInfo" class="driver-info">No driver info yet.</div>

<h4>Truck Photo</h4>
<div id="brokerPhotos">No photo yet.</div>

<h4>Pickup Checkpoint</h4>
<div id="brokerPickupPhoto">No pickup photo yet.</div>

<h4>Delivery Checkpoint</h4>
<div id="brokerDeliveryPhoto">No delivery photo yet.</div>

<details>
<summary>Tracking History</summary>
<div id="trackingHistory">No location updates yet.</div>
</details>

<label>Ping Trigger</label>
<select id="pingMode">
<option value="time">Time-Based</option>
<option value="distance">Distance-Based (Future)</option>
</select>

<select id="pingInterval">
<option value="300000">Every 5 Minutes</option>
<option value="900000">Every 15 Minutes</option>
<option value="1800000">Every 30 Minutes</option>
<option value="3600000">Every 60 Minutes</option>
</select>

<select id="distanceInterval" class="hidden">
<option value="50">Every 50 Miles</option>
<option value="100">Every 100 Miles</option>
</select>

<h4>Notifications & Alerts</h4>
<div id="brokerAlerts"></div>

<h4>Messages</h4>
<div id="brokerMessages"></div>

<textarea id="brokerMessage" rows="3" placeholder="Type message..."></textarea>
<button onclick="sendBrokerMessage()">Send</button>
</div>

<!-- Geofence Setup above the map -->
<div class="card hidden" id="geofenceCard">
<h4>Geofence Setup (Optional - Alert on Deviation)</h4>
<p style="font-size:14px;">Click on the map to set a geofence center, then enter radius in miles.</p>
<div id="geofenceStatus" style="margin-bottom:10px; color:#94a3b8;">No geofence set</div>
<input type="number" id="geofenceRadius" placeholder="Radius in miles (e.g. 5)" min="1" max="50">
<button onclick="setGeofence()">Set Geofence</button>
<button onclick="clearGeofence()">Clear Geofence</button>
</div>

<!-- Map -->
<div class="card hidden" id="mapCard">
<h3>Live Map</h3>
<div id="map"></div>
</div>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
// All data stored in URL (no backend)
let sessionData = {
  ref: null,
  driverInfo: {},
  truckPhoto: null,
  pickupPhoto: null,
  deliveryPhoto: null,
  messages: [],
  history: [],
  geofence: null,
  alerts: []
};

let map = null, marker = null, watchId = null;
let geofenceCircle = null, geofenceCenter = null, geofenceRadiusMiles = 0;

// Role selection
function selectRole(role) {
  document.getElementById("roleSelect").classList.add("hidden");
  if (role === "carrier") {
    document.getElementById("carrierPanel").classList.remove("hidden");
    sessionData.ref = "TR-" + Math.random().toString(36).substring(2, 8).toUpperCase();
    document.getElementById("refNumber").textContent = sessionData.ref;
    updateURL();
  } else {
    document.getElementById("brokerPanel").classList.remove("hidden");
    document.getElementById("geofenceCard").classList.remove("hidden");
    document.getElementById("mapCard").classList.remove("hidden");
    loadFromURL();
  }
}

function copyRef() {
  navigator.clipboard.writeText(sessionData.ref).then(() => {
    document.getElementById("copyStatus").textContent = "Copied!";
    setTimeout(() => document.getElementById("copyStatus").textContent = "", 2000);
  });
}

// Update URL with session data
function updateURL() {
  const params = new URLSearchParams();
  params.set('data', btoa(JSON.stringify(sessionData)));
  history.replaceState(null, '', '?' + params.toString());
}

// Load from URL
function loadFromURL() {
  const params = new URLSearchParams(location.search);
  if (params.has('data')) {
    try {
      sessionData = JSON.parse(atob(params.get('data')));
      renderBrokerView();
    } catch (e) {
      console.error("Invalid data in URL");
    }
  }
}

// Geofence
function setGeofence() {
  const radiusInput = document.getElementById("geofenceRadius").value;
  if (!geofenceCenter) return alert("Click on the map first to set the geofence center.");
  if (!radiusInput || radiusInput <= 0) return alert("Enter a valid radius in miles.");
  geofenceRadiusMiles = parseFloat(radiusInput);
  const radiusMeters = geofenceRadiusMiles * 1609.34;

  if (geofenceCircle) map.removeLayer(geofenceCircle);
  geofenceCircle = L.circle(geofenceCenter, { radius: radiusMeters, className: 'geofence-circle' }).addTo(map);
  L.marker(geofenceCenter).addTo(map).bindPopup(`Geofence Center<br>Radius: ${geofenceRadiusMiles} miles`).openPopup();

  document.getElementById("geofenceStatus").textContent = `Geofence active: ${geofenceRadiusMiles} mile radius`;

  sessionData.geofence = { lat: geofenceCenter.lat, lng: geofenceCenter.lng, radiusMiles: geofenceRadiusMiles };
  updateURL();
}

function clearGeofence() {
  if (geofenceCircle) map.removeLayer(geofenceCircle);
  geofenceCircle = null;
  geofenceCenter = null;
  geofenceRadiusMiles = 0;
  document.getElementById("geofenceStatus").textContent = "No geofence set";
  document.getElementById("geofenceRadius").value = "";
  sessionData.geofence = null;
  updateURL();
}

function onMapClick(e) {
  geofenceCenter = e.latlng;
  document.getElementById("geofenceStatus").textContent = `Center set — enter radius and click Set Geofence`;
}

// Carrier Lookup
function lookupCarrier() {
  const btn = document.getElementById("lookupBtn");
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = 'Searching<span class="spinner"></span>';

  const input = document.getElementById("lookupInput").value.trim();
  const resultDiv = document.getElementById("lookupResult");
  if (!input) {
    resultDiv.innerHTML = "Please enter an MC or DOT number.";
    btn.disabled = false;
    btn.innerHTML = originalText;
    return;
  }
  const num = input.replace(/[^0-9]/g, '');
  const saferUrl = `https://safer.fmcsa.dot.gov/query.asp?searchtype=ANY&query_type=queryCarrierSnapshot&query_param=MC_MX&query_string=${num}`;
  const liUrl = "https://li-public.fmcsa.dot.gov/LIVIEW/pkg_carrquery.prc_carrlist";

  resultDiv.innerHTML = `
    <strong>Official FMCSA Carrier Profiles for ${num}:</strong><br><br>
    <a href="${saferUrl}" target="_blank" style="color:#22c55e; font-size:16px;">
      Basic Carrier Snapshot & Authority (SAFER) 
    </a><br><br>
    <a href="${liUrl}" target="_blank" style="color:#22c55e; font-size:16px;">
      Insurance & Licensing Details (L&I) 
    </a><br><br>
    <small>For Insurance & Licensing: Open the link and search using the carrier's MC or USDOT number (found on the SAFER page).</small>
  `;

  btn.disabled = false;
  btn.innerHTML = originalText;
}

// Image compression
async function compressImage(file, maxWidth = 1200, quality = 0.8) {
  return new Promise(resolve => {
    const img = new Image();
    const reader = new FileReader();
    reader.onload = e => img.src = e.target.result;
    img.onload = () => {
      const canvas = document.createElement('canvas');
      let w = img.width, h = img.height;
      if (w > maxWidth) { h = (maxWidth / w) * h; w = maxWidth; }
      canvas.width = w; canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      canvas.toBlob(blob => resolve(blob), "image/jpeg", quality);
    };
    reader.readAsDataURL(file);
  });
}

// Photo handling
function setupPhotoHandler(inputId, previewId, statusId, key) {
  document.getElementById(inputId).addEventListener("change", async e => {
    const file = e.target.files[0];
    if (!file) return;
    const preview = document.getElementById(previewId);
    const status = document.getElementById(statusId);
    preview.src = URL.createObjectURL(file);
    preview.classList.remove("hidden");
    status.textContent = "Compressing...";
    try {
      const compressedBlob = await compressImage(file);
      const reader = new FileReader();
      reader.onload = () => {
        sessionData[key] = reader.result;
        status.textContent = "Ready";
        updateURL();
      };
      reader.readAsDataURL(compressedBlob);
    } catch {
      status.textContent = "Using original";
    }
  });
}

setupPhotoHandler("truckPhoto", "truckPreview", "photoStatus", "truckPhoto");
setupPhotoHandler("pickupPhoto", "pickupPreview", "pickupStatus", "pickupPhoto");
setupPhotoHandler("deliveryPhoto", "deliveryPreview", "deliveryStatus", "deliveryPhoto");

function initMap() {
  if (map) return;
  map = L.map('map').setView([39.8, -98.5], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  map.on('click', onMapClick);
  setTimeout(() => map.invalidateSize(), 300);
}

function startGPS() {
  if (!navigator.geolocation) return alert("Geolocation not supported.");
  watchId = navigator.geolocation.watchPosition(pos => {
    const lat = pos.coords.latitude, lng = pos.coords.longitude;
    const time = new Date().toLocaleString();
    sessionData.history.push({ lat, lng, time });
    if (sessionData.history.length > 50) sessionData.history.shift();
    updateURL();

    if (sessionData.geofence) {
      const dist = map.distance([lat, lng], [sessionData.geofence.lat, sessionData.geofence.lng]) / 1609.34;
      if (dist > sessionData.geofence.radiusMiles) {
        sessionData.alerts.push({
          message: `Truck left geofence (${dist.toFixed(1)} miles from center)`,
          time
        });
        updateURL();
      }
    }

    const latlng = [lat, lng];
    if (marker) marker.setLatLng(latlng);
    else marker = L.marker(latlng).addTo(map).bindPopup("Carrier").openPopup();
    map.setView(latlng, 13);
  }, err => alert("Location access denied."), { enableHighAccuracy: true });
}

// Carrier start tracking
document.getElementById("startTracking").onclick = async function () {
  const btn = this;
  if (btn.textContent.includes("Pause")) {
    navigator.geolocation.clearWatch(watchId);
    btn.textContent = "Resume Tracking";
    return;
  }
  if (btn.textContent.includes("Resume")) {
    startGPS();
    btn.textContent = "Pause Tracking";
    return;
  }

  if (!sessionData.truckPhoto) return alert("Truck photo is required.");

  sessionData.driverInfo = {
    name: document.getElementById("driverName").value.trim(),
    phone: document.getElementById("driverPhone").value.trim(),
    mc: document.getElementById("mcNumber").value.trim()
  };

  document.getElementById("photoStatus").textContent = "Session active — share reference with broker";
  initMap();
  startGPS();
  btn.textContent = "Pause Tracking";
  document.getElementById("cancelTracking").classList.remove("hidden");
  updateURL();
};

document.getElementById("cancelTracking").onclick = () => {
  navigator.geolocation.clearWatch(watchId);
  location.reload();
};

function sendMessage() {
  const msg = document.getElementById("carrierMessage").value.trim();
  if (msg) {
    sessionData.messages.push({ from: "carrier", text: msg, time: new Date().toLocaleTimeString() });
    document.getElementById("carrierMessage").value = "";
    renderCarrierMessages();
    updateURL();
  }
}

function renderCarrierMessages() {
  const div = document.getElementById("carrierMessages");
  div.innerHTML = sessionData.messages.map(m => 
    `<div class="message"><strong>${m.from === "broker" ? "Broker" : "You"}:</strong> ${m.text}</div>`
  ).join("");
}

// Broker tracking
function startBrokerTracking() {
  loadFromURL();
  renderBrokerView();
  initMap();
  document.getElementById("cancelBrokerBtn").classList.remove("hidden");
}

function renderBrokerView() {
  const d = sessionData;

  document.getElementById("brokerDriverInfo").innerHTML = `
    <strong>Name:</strong> ${d.driverInfo.name || "Not provided"}<br>
    <strong>Phone:</strong> ${d.driverInfo.phone || "Not provided"}<br>
    <strong>MC#:</strong> ${d.driverInfo.mc || "Not provided"}`;

  document.getElementById("brokerPhotos").innerHTML = d.truckPhoto ?
    `<img src="${d.truckPhoto}" class="photo-preview">` : "Waiting for truck photo...";

  document.getElementById("brokerPickupPhoto").innerHTML = d.pickupPhoto ?
    `<img src="${d.pickupPhoto}" class="photo-preview">` : "No pickup photo yet.";

  document.getElementById("brokerDeliveryPhoto").innerHTML = d.deliveryPhoto ?
    `<img src="${d.deliveryPhoto}" class="photo-preview">` : "No delivery photo yet.";

  document.getElementById("brokerMessages").innerHTML = d.messages.map(m => 
    `<div class="message"><strong>${m.from === "carrier" ? "Carrier" : "You"}:</strong> ${m.text}</div>`
  ).join("");

  document.getElementById("trackingHistory").innerHTML = d.history.length ? d.history.reverse()
    .map(e => `<div class="history-item">${e.time}<br>Lat: ${e.lat.toFixed(6)}, Lng: ${e.lng.toFixed(6)}</div>`)
    .join("") : "No location updates yet.";

  if (d.geofence && !geofenceCircle) {
    const radiusMeters = d.geofence.radiusMiles * 1609.34;
    geofenceCircle = L.circle([d.geofence.lat, d.geofence.lng], { radius: radiusMeters, className: 'geofence-circle' }).addTo(map);
  }

  const alertsDiv = document.getElementById("brokerAlerts");
  alertsDiv.innerHTML = "";
  d.alerts.slice().reverse().slice(0,10).forEach(alert => {
    const div = document.createElement("div");
    div.className = "alert";
    div.style.background = "#7f1d1d";
    div.textContent = `ALERT: ${alert.message} • ${alert.time}`;
    alertsDiv.prepend(div);
  });
}

function cancelBrokerTracking() {
  location.reload();
}

function sendBrokerMessage() {
  const msg = document.getElementById("brokerMessage").value.trim();
  if (msg) {
    sessionData.messages.push({ from: "broker", text: msg, time: new Date().toLocaleTimeString() });
    document.getElementById("brokerMessage").value = "";
    renderBrokerView();
    updateURL();
  }
}

document.getElementById("pingMode").onchange = () => {
  const time = document.getElementById("pingMode").value === "time";
  document.getElementById("pingInterval").classList.toggle("hidden", !time);
  document.getElementById("distanceInterval").classList.toggle("hidden", time);
};

// Auto-refresh broker view every 5 seconds
setInterval(() => {
  if (!document.getElementById("brokerPanel").classList.contains("hidden")) {
    loadFromURL();
    renderBrokerView();
  }
}, 5000);
</script>
</body>
</html>